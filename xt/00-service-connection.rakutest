use v6.d;
use WWW::Ollama;
use WWW::Ollama::Client;
use Test;

## 1
subtest {
    my $ollama = WWW::Ollama::Client.new;
    is $ollama.http.port, 11434, 'expected port';
    is $ollama.http.host, '127.0.0.1', 'expected host';
    is $ollama.http.scheme, 'http', 'expected scheme';
}, 'default connection';

## 2
subtest {

    my $OLLAMA_API_KEY=%*ENV<OLLAMA_API_KEY>;

    my $client = WWW::Ollama::Client.new(
            host => "https://ollama.com",
            #:443port,
            api-key => $OLLAMA_API_KEY
            );
    is $client.http.port, 443, 'expected port';
    is $client.http.host, 'ollama.com', 'expected host';
    is $client.http.scheme, 'https', 'expected scheme';

    $client = WWW::Ollama::Client.new(
            host => "http://ollama.com",
            api-key => $OLLAMA_API_KEY
            );
    is $client.http.port, 80, 'expected port';
    is $client.http.host, 'ollama.com', 'expected host';
    is $client.http.scheme, 'http', 'expected scheme';

    ## This does not work
    #say ollama-completion('Population of Brazil', :$client);

}, 'Ollama server connection';

# Separate, "just cUrl" check using authorization. (That works.)
#`[

    my $cmd = q:s:to/END/;
curl -v https://ollama.com/api/generate \
  --header "Authorization: Bearer $OLLAMA_API_KEY" \
  --header 'Content-Type: application/json' \
  --data '{
    "model": "gpt-oss:20b",
    "prompt": "Why is the sky blue?",
    "stream": false
  }'
END

    my $proc = shell $cmd, :out;
    my $captured-output = $proc.out.slurp: :close;

    say $captured-output;
]

done-testing;
